{% extends 'base.html' %}

{% block css_link %}
<link rel='stylesheet' href="{{ url_for('static', filename='chat_room.css') }}">
{% endblock %}

{% block body %}

<script type="text/javascript">
  const socket = io();

  socket.on('connect', () => {
    socket.emit('join_room', {
    username: "{{ username }}",
    room: "{{ room._id }}"
    });

    let message_input = document.querySelector(".msg-input-box");
    document.querySelector(".input-box-btn").onsubmit = (e) => {
      e.preventDefault();
      let message = message_input.value.trim();
      if (message.length) {
          socket.emit('send_message', {
            username: "{{ username }}",
            room: "{{ room._id }}",
            message: message
        });
      };
      message_input.value = '';
      message_input.focus();
    };

    window.onbeforeunload = () => {
      socket.emit('leave_room', {
        username: "{{ username }}",
        room: "{{ room._id }}"
      })
    };

    // socket.on('disconnect', () => {
    //   const chat_area = $('.chat-content-area');
    //   chat_area.append(`<p class="user-msg">{{username}} has left the chat!</p>`);
    //   socket.emit('disconnect_user', {
    //     username: "{{username}}"
    //   });
    // })

    document.querySelector('.navbar-link').addEventListener('click', () => {
      socket.emit('disconnect_user', {
      username: "{{ username }}"
      });
    });
  });

  socket.on('receive_message', (data) => {
    const chat_area = $('.chat-content-area');
    chat_area.append(`<p class="user-msg"><b>${data.username}</b>: ${data.message}</p>`);
  })

  socket.on('join_room_announcement', (data) => {
    if (data.username.length) {
      // const chat_users = $('.chat-users')
      // chat_users.append(`<p class="user-name">${data.username}</p>`);
      const chat_area = $('.chat-content-area');
      chat_area.append(`<p class="user-msg"><b>${data.username}</b> has joined the chat.</p>`);
  }});

  socket.on('leave_chat_announcement', (data) => {
    const chat_area = $('.chat-content-area');
    chat_area.append(`<p class="user-msg"><b>{{username}}</b> has left the chat!</p>`);
  });

</script>


<!-- Navbar with a brand and a log out button. -->
<header id="navbar">
  <nav class="navbar-container container">
    <a class="navbar-brand" href="#">Chat Room</a>
    <button type="button" class="navbar-toggle" aria-label="Open navigation menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <div class="navbar-menu">
      <ul class="navbar-links">
        <li class="navbar-item"><a class="navbar-link" href="/logout">Log out</a></li>
      </ul>
    </div>
  </nav>
</header>

<!-- Chat Container. -->
<div class="chat-container">
  <!-- Number of logged in users will be shows here. -->
  <div class="chat-users">
    <h1>Room {{ room.room_name }}</h1>
    {% for member in room_members %}
      <p class="user-name">{{ member._id.username }}</p>
    {% endfor %}
  </div>

  <!-- Chat area contains the chat msg area, input box and send button. -->
  <div class="chat-area">
    <!-- Messages will be shows here. -->
    <div class="chat-content-area" id="scroll">
    </div>

    <!-- Container for input box and send button. -->
    <form class="input-box-btn">
      <input type="text" name="msg-input-box" class="msg-input-box" placeholder="Type a message">
      <button class="chat-send-btn" type="submit"><i class="fa fa-paper-plane" aria-hidden="true"></i></button>
    </form>
  </div>
</div>
{% endblock %}

{% block script_link %}
<script type="text/javascript" src="{{ url_for('static', filename='chat_room.js') }}"></script>
{% endblock %}
